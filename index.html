<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üíó Gutachten Manager Deluxe</title>
  <meta name="theme-color" content="#ff69b4" />

  <style>
    :root{
      --pink:#ff69b4; --pink2:#ffb6c1; --bg:#ffe6f0; --card:#fff;
      --border:rgba(0,0,0,.10); --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:18px; --muted:#666;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 600px at 10% 0%, #fff 0%, var(--bg) 45%, #ffd6ea 100%);}
    .wrap{max-width:1300px;margin:20px auto;padding:15px;}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:16px;margin-bottom:14px;border:1px solid var(--border);}
    h1{margin:0 0 6px;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin:0;line-height:1.35}
    .grid{display:grid;gap:14px;}
    @media(min-width:980px){.grid{grid-template-columns:420px 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin-top:10px;margin-bottom:6px}
    input,select{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--border);
      background:#fff;outline:none;
    }
    input:focus,select:focus{box-shadow:0 0 0 4px rgba(255,105,180,.14);border-color:rgba(255,105,180,.6)}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:650;cursor:pointer;background:var(--pink2);}
    button:hover{filter:brightness(.96)}
    .btn-outline{background:#fff;border:1px solid var(--border);font-weight:650}
    .danger{background:#fff;border:1px solid rgba(200,60,60,.35);color:#8b1f1f}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .small{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}

    .tableWrap{overflow:auto;border:1px solid rgba(0,0,0,.08);border-radius:12px;background:rgba(255,255,255,.75)}
    table{width:100%;border-collapse:collapse;min-width:1300px}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(0,0,0,.06);font-size:13px;white-space:nowrap;text-align:left}
    th{background:rgba(250,250,250,.95);position:sticky;top:0;z-index:1;color:var(--muted);font-size:12px}

    .pill{padding:3px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.12);font-size:12px;background:#fff}
    .paid{background:#e7f8ee;border-color:#8ccfa6}
    .unpaid{background:#fdeaea;border-color:#e6a0a0}
    .tag-ok{background:#e7f8ee;border-color:#8ccfa6}
    .tag-warn{background:#fdeaea;border-color:#e6a0a0}

    .bar{height:14px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden;margin-top:8px}
    .bar div{height:100%;background:linear-gradient(90deg,#ff9acb,var(--pink));width:0%}

    nav button.tab-active{background:linear-gradient(90deg,#ff9acb,var(--pink))}
    .toast{
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:#fff;border:1px solid var(--border);padding:10px 14px;border-radius:999px;
      box-shadow:var(--shadow);display:none;z-index:20;
    }
    .toast.show{display:block}
    .icon-btn{padding:8px 10px;border-radius:10px}
    .inline{display:inline-flex;align-items:center;gap:8px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>üíó Gutachten Manager Deluxe</h1>
    <p class="sub">
      Arbeitsplan + Gutachten ‚Äì lokal gespeichert. ‚úÖ H√§kchen im Arbeitsplan = automatisch als Gutachten speichern.
      ‚úèÔ∏è Bearbeiten aktualisiert beide Tabs (wenn verkn√ºpft).
    </p>
  </div>

  <!-- Tabs: Arbeitsplan zuerst -->
  <nav class="card">
    <div class="btns" style="margin-top:0">
      <button id="tabPlanBtn" class="btn-outline">üìÖ Arbeitsplan</button>
      <button id="tabGutachtenBtn" class="btn-outline">üíó Gutachten</button>
    </div>
  </nav>

  <!-- ================= ARBEITSPLAN ================= -->
  <div id="sectionPlan">
    <div class="grid">

      <section class="card">
        <h3 style="margin:0 0 6px;">üìÖ Arbeitsplan</h3>
        <p class="sub">
          T√§tigkeit = Kategorie im Gutachten. Honorar & Kumuliert werden <b>manuell</b> eingetragen.
          ‚úèÔ∏è Bearbeiten + Speichern aktualisiert auch das verkn√ºpfte Gutachten.
        </p>

        <label for="planDatum">Datum</label>
        <input id="planDatum" type="date" />

        <div class="row2">
          <div>
            <label for="planVon">Von</label>
            <input id="planVon" type="time" />
          </div>
          <div>
            <label for="planBis">Bis</label>
            <input id="planBis" type="time" />
          </div>
        </div>

        <label for="planTaetigkeit">T√§tigkeit</label>
        <select id="planTaetigkeit"></select>

        <div class="row2">
          <div>
            <label for="planGutNr">Gutachten-Nr.</label>
            <input id="planGutNr" placeholder="z.B. 12" />
          </div>
          <div>
            <label for="planHonorar">Honorar pro Eintrag (‚Ç¨)</label>
            <input id="planHonorar" type="number" step="0.01" min="0" max="1000" placeholder="z.B. 450" />
          </div>
        </div>

        <label for="planKumuliert">Kumuliertes Honorar (‚Ç¨)</label>
        <input id="planKumuliert" type="number" step="0.01" min="0" placeholder="z.B. 1200" />

        <label for="planNotiz">Notiz</label>
        <input id="planNotiz" placeholder="z.B. Klient/Ort/Infos..." />

        <div class="btns">
          <button id="planSaveBtn">üíæ Speichern</button>
          <button id="planCancelEditBtn" class="btn-outline" style="display:none;">‚Ü©Ô∏é Abbrechen</button>
          <button id="planClearBtn" class="danger">üóë Plan komplett l√∂schen</button>
        </div>

        <div class="small" id="planEditInfo"></div>
      </section>

      <section class="card">
        <div class="small" id="planStats" style="margin-top:0;">‚Äî</div>

        <div class="tableWrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Datum</th>
                <th>Zeit</th>
                <th>T√§tigkeit</th>
                <th>Gutachten-Nr.</th>
                <th>Honorar (‚Ç¨)</th>
                <th>Kumuliert (‚Ç¨)</th>
                <th>Notiz</th>
                <th>Erledigt ‚úÖ</th>
                <th>√úbertragen üíæ</th>
                <th>Bearbeiten ‚úèÔ∏è</th>
                <th>L√∂schen</th>
              </tr>
            </thead>
            <tbody id="planTbody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </div>

  <!-- ================= GUTACHTEN ================= -->
  <div id="sectionGutachten" style="display:none">
    <div class="grid">

      <section class="card">
        <h3 style="margin:0 0 6px;">üíó Gutachten</h3>
        <p class="sub">‚úèÔ∏è Bearbeiten aktualisiert auch den verkn√ºpften Arbeitsplan-Eintrag (falls vorhanden).</p>

        <label for="gutachten">Gutachten</label>
        <input id="gutachten" placeholder="z.B. Gutachten Nr. 12" />

        <label for="kosten">Kosten (‚Ç¨ max 1000)</label>
        <input id="kosten" type="number" step="0.01" min="0" max="1000" placeholder="z.B. 450" />

        <label for="kategorie">Kategorie</label>
        <select id="kategorie"></select>

        <label for="klient">Klient</label>
        <input id="klient" placeholder="optional" />

        <label for="datum">Datum</label>
        <input id="datum" type="date" />

        <label for="bezahlt">Bezahlt</label>
        <select id="bezahlt">
          <option value=""></option>
          <option value="Ja">Ja</option>
          <option value="Nein">Nein</option>
        </select>

        <div class="btns">
          <button id="saveBtn">üíæ Speichern</button>
          <button id="gutCancelEditBtn" class="btn-outline" style="display:none;">‚Ü©Ô∏é Abbrechen</button>
          <button id="chartBtn" class="btn-outline">üìä Diagramm</button>
        </div>

        <div class="small" id="progressLabel">‚Äî</div>
        <div class="bar"><div id="barFill"></div></div>

        <div class="small" id="gutEditInfo"></div>
      </section>

      <section class="card">
        <div class="btns" style="margin-top:0">
          <button id="exportBtn" class="btn-outline">‚¨á CSV Export</button>
          <label class="btn-outline" style="padding:10px 14px;border-radius:12px;cursor:pointer;">
            ‚¨Ü CSV Import
            <input type="file" id="importFile" hidden accept=".csv,text/csv">
          </label>
          <button id="clearBtn" class="danger">üóë Alles l√∂schen</button>
        </div>

        <div class="tableWrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Datum</th><th>Gutachten</th><th>Kosten (‚Ç¨)</th><th>Kategorie</th><th>Klient</th><th>Bezahlt</th>
                <th>Bearbeiten ‚úèÔ∏è</th><th>L√∂schen</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <canvas id="chart" height="120" style="display:none;margin-top:14px"></canvas>
      </section>

    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
  // ================= Konfig =================
  const ZIELBETRAG = 45000;
  const GKEY = "gutachten_v4";
  const PKEY = "arbeitsplan_v4";

  // Einheitliche Dropdown-Optionen (T√§tigkeit + Kategorie)
  const CATEGORY_OPTIONS = ["Gutachten", "Ordination", "BBRZ", "Pause"];

  const $ = (id) => document.getElementById(id);

  // ================= Helpers =================
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.classList.remove("show"), 2200);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function load(key){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function save(key, arr){
    localStorage.setItem(key, JSON.stringify(arr));
  }

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function fmtEuro(n){
    const v = Number(n) || 0;
    return v.toLocaleString("de-AT", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function timeRange(von,bis){
    const a = (von||"").trim();
    const b = (bis||"").trim();
    if(!a && !b) return "";
    if(a && b) return `${a}‚Äì${b}`;
    return a || b;
  }

  function fillSelect(selectEl, options){
    selectEl.innerHTML = `<option value=""></option>` + options.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
  }

  function clampMoney(n){
    const v = Number(n);
    if(!Number.isFinite(v)) return null;
    if(v < 0) return null;
    if(v > 1000) return null;
    return v;
  }

  // ================= Tabs =================
  const tabGutachtenBtn = $("tabGutachtenBtn");
  const tabPlanBtn = $("tabPlanBtn");
  const sectionGutachten = $("sectionGutachten");
  const sectionPlan = $("sectionPlan");

  function showTab(name){
    const isPlan = name === "plan";
    sectionPlan.style.display = isPlan ? "block" : "none";
    sectionGutachten.style.display = isPlan ? "none" : "block";
    tabPlanBtn.classList.toggle("tab-active", isPlan);
    tabGutachtenBtn.classList.toggle("tab-active", !isPlan);
  }
  tabPlanBtn.addEventListener("click", ()=>showTab("plan"));
  tabGutachtenBtn.addEventListener("click", ()=>showTab("gutachten"));

  // ================= Link-Updates (Plan <-> Gutachten) =================
  function updatePlanFromGutachten(g){
    // Wenn Gutachten mit planId verkn√ºpft ist, update Plan-Felder (Honorar = Kosten, T√§tigkeit = Kategorie, Notiz = Klient, Datum)
    if(!g.planId) return;
    const plan = load(PKEY);
    const idx = plan.findIndex(x=>x.id === g.planId);
    if(idx < 0) return;
    plan[idx].Datum = g.Datum || plan[idx].Datum;
    plan[idx].Taetigkeit = g.Kategorie || plan[idx].Taetigkeit;
    plan[idx].Notiz = g.Klient || plan[idx].Notiz;
    // Honorar als Kosten spiegeln
    plan[idx].Honorar = Number(g.Kosten) || plan[idx].Honorar;
    // Kumuliert bleibt, weil du es manuell pflegst
    save(PKEY, plan);
  }

  function updateGutachtenFromPlan(p){
    // Wenn Plan √ºbertragen und gutId vorhanden: update Gutachten
    if(!p.Uebertragen || !p.gutId) return;
    const guts = load(GKEY);
    const idx = guts.findIndex(x=>x.id === p.gutId);
    if(idx < 0) return;

    const gutName = p.GutNr ? `Gutachten Nr. ${p.GutNr}` : (p.Taetigkeit || "Eintrag");

    guts[idx].Datum = p.Datum || guts[idx].Datum;
    guts[idx].Kategorie = p.Taetigkeit || guts[idx].Kategorie;
    guts[idx].Klient = p.Notiz || guts[idx].Klient;
    // Kosten = Honorar pro Eintrag
    guts[idx].Kosten = Number(p.Honorar) || 0;
    guts[idx].Gutachten = gutName;

    save(GKEY, guts);
  }

  // ================= Gutachten =================
  let chartInstance = null;
  let editingGutId = null;

  function sumEinnahmen(entries){
    return entries.reduce((acc,e)=> acc + (Number(e.Kosten) || 0), 0);
  }

  function renderProgress(entries){
    const einnahmen = sumEinnahmen(entries);
    const prozent = Math.min(Math.floor((einnahmen / ZIELBETRAG) * 100), 100);
    $("progressLabel").textContent =
      `Einnahmen: ${fmtEuro(einnahmen)} ‚Ç¨ / 45.000 ‚Ç¨ | Gutachten: ${entries.length} | ${prozent}% erreicht`;
    $("barFill").style.width = `${Math.max(0, Math.min(100, prozent))}%`;
  }

  function renderGutTable(entries){
    const tb = $("tbody");
    tb.innerHTML = "";
    const sorted = [...entries].sort((a,b)=> (b.Datum||"").localeCompare(a.Datum||""));
    for(const e of sorted){
      const paid = (e.Bezahlt||"") === "Ja";
      tb.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${escapeHtml(e.Datum||"")}</td>
          <td>${escapeHtml(e.Gutachten||"")}</td>
          <td>${escapeHtml(fmtEuro(e.Kosten))}</td>
          <td>${escapeHtml(e.Kategorie||"")}</td>
          <td>${escapeHtml(e.Klient||"")}</td>
          <td><span class="pill ${paid ? "paid" : "unpaid"}">${escapeHtml(e.Bezahlt||"")}</span></td>
          <td><button class="btn-outline icon-btn" data-gedit="${escapeHtml(e.id)}" title="Bearbeiten">‚úèÔ∏è</button></td>
          <td><button class="danger icon-btn" data-gdel="${escapeHtml(e.id)}" title="L√∂schen">üóë</button></td>
        </tr>
      `);
    }

    tb.querySelectorAll('button[data-gedit]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        startEditGutachten(btn.getAttribute("data-gedit"));
      });
    });
    tb.querySelectorAll('button[data-gdel]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        deleteGutachten(btn.getAttribute("data-gdel"));
      });
    });
  }

  function renderGutachten(){
    const entries = load(GKEY);
    renderGutTable(entries);
    renderProgress(entries);
  }

  function addOrUpdateGutachten(entry){
    const k = clampMoney(entry.Kosten);
    if(k === null){ alert("Kosten m√ºssen 0‚Äì1000 ‚Ç¨ sein."); return false; }
    entry.Kosten = k;

    const entries = load(GKEY);

    if(editingGutId){
      const idx = entries.findIndex(x=>x.id === editingGutId);
      if(idx < 0){ editingGutId = null; return false; }

      const old = entries[idx];
      entry.id = old.id;
      entry.planId = old.planId || null; // Link behalten

      entries[idx] = entry;
      save(GKEY, entries);

      // Link zur√ºck in Plan updaten
      updatePlanFromGutachten(entry);

      toast("Gutachten aktualisiert.");
      stopEditGutachten();
      renderGutachten();
      renderPlan();
      return true;
    }else{
      entry.id = uid();
      entry.planId = entry.planId || null;
      entries.push(entry);
      save(GKEY, entries);
      toast("Gutachten gespeichert.");
      renderGutachten();
      return true;
    }
  }

  function startEditGutachten(id){
    const entries = load(GKEY);
    const e = entries.find(x=>x.id === id);
    if(!e) return;

    editingGutId = id;
    $("gutachten").value = e.Gutachten || "";
    $("kosten").value = (Number(e.Kosten)||0);
    $("kategorie").value = e.Kategorie || "";
    $("klient").value = e.Klient || "";
    $("datum").value = e.Datum || todayISO();
    $("bezahlt").value = e.Bezahlt || "";

    $("gutCancelEditBtn").style.display = "inline-block";
    $("gutEditInfo").textContent = "‚úèÔ∏è Bearbeiten aktiv ‚Äì Speichern √ºberschreibt diesen Eintrag.";
    showTab("gutachten");
  }

  function stopEditGutachten(){
    editingGutId = null;
    $("gutCancelEditBtn").style.display = "none";
    $("gutEditInfo").textContent = "";
    $("gutachten").value = "";
    $("kosten").value = "";
    $("kategorie").value = "";
    $("klient").value = "";
    $("datum").value = todayISO();
    $("bezahlt").value = "";
  }

  function deleteGutachten(id){
    const entries = load(GKEY);
    const target = entries.find(x=>x.id === id);
    if(!target) return;

    if(!confirm("Dieses Gutachten wirklich l√∂schen?")) return;

    // Wenn verkn√ºpft: Plan bleibt, aber Uebertragen->false und gutId entfernen
    if(target.planId){
      const plan = load(PKEY);
      const pidx = plan.findIndex(x=>x.id === target.planId);
      if(pidx >= 0){
        plan[pidx].Uebertragen = false;
        plan[pidx].gutId = null;
        save(PKEY, plan);
      }
    }

    save(GKEY, entries.filter(x=>x.id !== id));
    if(editingGutId === id) stopEditGutachten();
    toast("Gutachten gel√∂scht.");
    renderGutachten();
    renderPlan();
  }

  $("saveBtn").addEventListener("click", ()=>{
    const entry = {
      Datum: $("datum").value || todayISO(),
      Gutachten: $("gutachten").value.trim(),
      Kosten: Number($("kosten").value),
      Kategorie: $("kategorie").value.trim(),
      Klient: $("klient").value.trim(),
      Bezahlt: $("bezahlt").value.trim(),
      // planId bleibt bei edit automatisch drin; beim manuellen neu speichern nicht verkn√ºpft
      planId: null
    };
    addOrUpdateGutachten(entry);
  });

  $("gutCancelEditBtn").addEventListener("click", ()=>{
    stopEditGutachten();
    toast("Bearbeiten abgebrochen.");
  });

  function monthlyAggregate(entries){
    const map = new Map();
    for(const e of entries){
      const key = (e.Datum || "").slice(0,7);
      if(!/^\d{4}-\d{2}$/.test(key)) continue;
      map.set(key, (map.get(key)||0) + (Number(e.Kosten)||0));
    }
    const labels = [...map.keys()].sort();
    return { labels, sums: labels.map(k => Math.round(map.get(k))) };
  }

  $("chartBtn").addEventListener("click", ()=>{
    const entries = load(GKEY);
    const { labels, sums } = monthlyAggregate(entries);
    const canvas = $("chart");
    canvas.style.display = "block";
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(canvas, {
      type:"bar",
      data:{ labels, datasets:[{ label:"Einnahmen (‚Ç¨)", data:sums }] },
      options:{ responsive:true, plugins:{ title:{ display:true, text:"Monatliche Einnahmen √úbersicht" } },
        scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
    });
    if(labels.length === 0) toast("Noch keine Daten f√ºrs Monatsdiagramm.");
  });

  // CSV Export/Import (Gutachten)
  function csvEscape(val){
    const s = String(val ?? "");
    if(/[",\n\r;]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }
  $("exportBtn").addEventListener("click", ()=>{
    const entries = load(GKEY);
    const header = ["Datum","Gutachten","Kosten","Kategorie","Klient","Bezahlt"];
    const lines = [header.join(",")];
    for(const e of entries){
      lines.push([
        e.Datum ?? "", e.Gutachten ?? "", e.Kosten ?? "", e.Kategorie ?? "", e.Klient ?? "", e.Bezahlt ?? ""
      ].map(csvEscape).join(","));
    }
    const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "gutachten_erweitert.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast("CSV exportiert.");
  });

  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    while(i < text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){
          const next = text[i+1];
          if(next === '"'){ field+='"'; i+=2; continue; }
          inQuotes = false; i++; continue;
        }
        field += c; i++; continue;
      }else{
        if(c === '"'){ inQuotes=true; i++; continue; }
        if(c === ","){ row.push(field); field=""; i++; continue; }
        if(c === "\n" || c === "\r"){
          if(c === "\r" && text[i+1] === "\n") i++;
          row.push(field); field="";
          if(row.length > 1 || row[0] !== "") rows.push(row);
          row=[]; i++; continue;
        }
        field += c; i++; continue;
      }
    }
    row.push(field);
    if(row.length > 1 || row[0] !== "") rows.push(row);
    return rows;
  }

  $("importFile").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if(!file){ e.target.value=""; return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const text = String(reader.result || "");
        const rows = parseCSV(text);
        if(rows.length === 0) throw new Error("CSV ist leer.");
        const header = rows[0].map(x=>x.trim().toLowerCase());
        const idx = (name)=> header.findIndex(h=>h===name.toLowerCase());
        const iDatum=idx("datum"), iGut=idx("gutachten"), iKos=idx("kosten"), iKat=idx("kategorie"), iKli=idx("klient"), iBez=idx("bezahlt");
        if([iDatum,iGut,iKos,iKat,iKli,iBez].some(x=>x<0)) throw new Error("CSV Header muss enthalten: Datum,Gutachten,Kosten,Kategorie,Klient,Bezahlt");
        const entries=[];
        for(let r=1;r<rows.length;r++){
          const cols=rows[r];
          const Kosten = Number(String(cols[iKos]||"").replace(",","."));
          const k = clampMoney(Kosten);
          if(k === null) continue;
          entries.push({
            id: uid(),
            planId: null,
            Datum:(cols[iDatum]||"").trim() || todayISO(),
            Gutachten:(cols[iGut]||"").trim(),
            Kosten: k,
            Kategorie:(cols[iKat]||"").trim(),
            Klient:(cols[iKli]||"").trim(),
            Bezahlt:(cols[iBez]||"").trim()
          });
        }
        save(GKEY, entries);
        stopEditGutachten();
        renderGutachten();
        toast(`CSV importiert (${entries.length} Eintr√§ge).`);
      }catch(err){
        alert("Import fehlgeschlagen: " + (err?.message || err));
      }
    };
    reader.readAsText(file);
    e.target.value="";
  });

  $("clearBtn").addEventListener("click", ()=>{
    if(confirm("Wirklich ALLE Gutachten l√∂schen?")){
      localStorage.removeItem(GKEY);
      if(chartInstance){ chartInstance.destroy(); chartInstance=null; }
      $("chart").style.display="none";
      stopEditGutachten();
      renderGutachten();
      renderPlan();
      toast("Alles gel√∂scht.");
    }
  });

  // ================= Arbeitsplan =================
  let editingPlanId = null;

  function planSorted(items){
    return [...items].sort((a,b)=>{
      const d = (a.Datum||"").localeCompare(b.Datum||"");
      if(d!==0) return d;
      return (a.Von||"").localeCompare(b.Von||"");
    });
  }

  function renderPlan(){
    const items = planSorted(load(PKEY));
    const total = items.length;
    const done = items.filter(x=>x.Erledigt).length;
    const transferred = items.filter(x=>x.Uebertragen).length;
    $("planStats").textContent = `Eintr√§ge: ${total} | Erledigt: ${done} | √úbertragen: ${transferred}`;

    const tb = $("planTbody");
    tb.innerHTML = "";

    for(const it of items){
      const hasTransfer = !!it.Uebertragen;
      const transferTag = hasTransfer
        ? `<span class="pill tag-ok">‚úì gespeichert</span>`
        : `<span class="pill tag-warn">nicht gespeichert</span>`;

      tb.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${escapeHtml(it.Datum||"")}</td>
          <td>${escapeHtml(timeRange(it.Von,it.Bis))}</td>
          <td>${escapeHtml(it.Taetigkeit||"")}</td>
          <td>${escapeHtml(it.GutNr||"")}</td>
          <td>${escapeHtml(fmtEuro(it.Honorar))}</td>
          <td>${escapeHtml(fmtEuro(it.Kumuliert))}</td>
          <td>${escapeHtml(it.Notiz||"")}</td>
          <td><input type="checkbox" data-done="${escapeHtml(it.id)}" ${it.Erledigt ? "checked" : ""} /></td>
          <td>
            <button class="btn-outline icon-btn" data-xfer="${escapeHtml(it.id)}" ${hasTransfer ? "disabled" : ""} title="Als Gutachten speichern">üíæ</button>
            <span style="margin-left:8px">${transferTag}</span>
          </td>
          <td><button class="btn-outline icon-btn" data-pedit="${escapeHtml(it.id)}" title="Bearbeiten">‚úèÔ∏è</button></td>
          <td><button class="danger icon-btn" data-del="${escapeHtml(it.id)}" title="L√∂schen">üóë</button></td>
        </tr>
      `);
    }

    tb.querySelectorAll('input[type="checkbox"][data-done]').forEach(cb=>{
      cb.addEventListener("change", (e)=>{
        const id = e.target.getAttribute("data-done");
        planSetDone(id, e.target.checked);
      });
    });

    tb.querySelectorAll('button[data-xfer]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-xfer");
        transferPlanToGutachten(id, { switchTab:true, autoDone:true });
      });
    });

    tb.querySelectorAll('button[data-pedit]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        startEditPlan(btn.getAttribute("data-pedit"));
      });
    });

    tb.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        planDelete(btn.getAttribute("data-del"));
      });
    });
  }

  function startEditPlan(id){
    const items = load(PKEY);
    const it = items.find(x=>x.id === id);
    if(!it) return;

    editingPlanId = id;

    $("planDatum").value = it.Datum || todayISO();
    $("planVon").value = it.Von || "";
    $("planBis").value = it.Bis || "";
    $("planTaetigkeit").value = it.Taetigkeit || "";
    $("planGutNr").value = it.GutNr || "";
    $("planHonorar").value = (Number(it.Honorar)||0);
    $("planKumuliert").value = (Number(it.Kumuliert)||0);
    $("planNotiz").value = it.Notiz || "";

    $("planCancelEditBtn").style.display = "inline-block";
    $("planEditInfo").textContent = "‚úèÔ∏è Bearbeiten aktiv ‚Äì Speichern √ºberschreibt diesen Eintrag (und ggf. das verkn√ºpfte Gutachten).";
    showTab("plan");
  }

  function stopEditPlan(){
    editingPlanId = null;
    $("planCancelEditBtn").style.display = "none";
    $("planEditInfo").textContent = "";
    $("planDatum").value = todayISO();
    $("planVon").value = "";
    $("planBis").value = "";
    $("planTaetigkeit").value = "";
    $("planGutNr").value = "";
    $("planHonorar").value = "";
    $("planKumuliert").value = "";
    $("planNotiz").value = "";
  }

  function planSaveOrUpdate(){
    const Taetigkeit = ($("planTaetigkeit").value || "").trim();
    if(!Taetigkeit){ alert("Bitte T√§tigkeit ausw√§hlen."); return; }

    const Honorar = clampMoney($("planHonorar").value || 0);
    if(Honorar === null){ alert("Honorar muss 0‚Äì1000 ‚Ç¨ sein."); return; }

    const Kum = Number($("planKumuliert").value || 0);
    if(!Number.isFinite(Kum) || Kum < 0){ alert("Kumuliertes Honorar muss >= 0 sein."); return; }

    const item = {
      id: editingPlanId || uid(),
      Datum: $("planDatum").value || todayISO(),
      Von: $("planVon").value || "",
      Bis: $("planBis").value || "",
      Taetigkeit,
      GutNr: $("planGutNr").value.trim(),
      Honorar: Honorar,
      Kumuliert: Kum,
      Notiz: $("planNotiz").value.trim(),
      Erledigt: false,
      Uebertragen: false,
      gutId: null
    };

    const items = load(PKEY);

    if(editingPlanId){
      const idx = items.findIndex(x=>x.id === editingPlanId);
      if(idx < 0){ stopEditPlan(); return; }

      // Status behalten
      item.Erledigt = !!items[idx].Erledigt;
      item.Uebertragen = !!items[idx].Uebertragen;
      item.gutId = items[idx].gutId || null;

      items[idx] = item;
      save(PKEY, items);

      // Wenn bereits √ºbertragen: Gutachten aktualisieren
      updateGutachtenFromPlan(item);

      toast("Arbeitsplan aktualisiert.");
      stopEditPlan();
      renderPlan();
      renderGutachten();
      return;
    }

    items.push(item);
    save(PKEY, items);

    toast("Arbeitsplan gespeichert.");
    stopEditPlan();
    renderPlan();
  }

  function planSetDone(id, done){
    const items = load(PKEY);
    const idx = items.findIndex(x=>x.id === id);
    if(idx < 0) return;

    items[idx].Erledigt = !!done;
    save(PKEY, items);
    renderPlan();

    // Wenn erledigt und noch nicht √ºbertragen -> automatisch √ºbertragen
    if(done && !items[idx].Uebertragen){
      transferPlanToGutachten(id, { switchTab:true, autoDone:false });
    }
  }

  function planDelete(id){
    const items = load(PKEY);
    const target = items.find(x=>x.id === id);
    if(!target) return;

    if(!confirm("Diesen Arbeitsplan-Eintrag wirklich l√∂schen?")) return;

    // Falls verkn√ºpftes Gutachten existiert: auch l√∂schen?
    // Ich mache es "sicher": Plan l√∂schen -> Gutachten bleibt, aber Link wird entfernt.
    if(target.gutId){
      const guts = load(GKEY);
      const gidx = guts.findIndex(x=>x.id === target.gutId);
      if(gidx >= 0){
        guts[gidx].planId = null;
        save(GKEY, guts);
      }
    }

    save(PKEY, items.filter(x=>x.id !== id));
    if(editingPlanId === id) stopEditPlan();
    toast("Plan-Eintrag gel√∂scht.");
    renderPlan();
    renderGutachten();
  }

  $("planSaveBtn").addEventListener("click", planSaveOrUpdate);
  $("planCancelEditBtn").addEventListener("click", ()=>{
    stopEditPlan();
    toast("Bearbeiten abgebrochen.");
  });

  $("planClearBtn").addEventListener("click", ()=>{
    if(confirm("Wirklich den kompletten Arbeitsplan l√∂schen?")){
      localStorage.removeItem(PKEY);
      stopEditPlan();
      renderPlan();
      toast("Arbeitsplan gel√∂scht.");
    }
  });

  function transferPlanToGutachten(id, opts){
    const { switchTab, autoDone } = opts || { switchTab:true, autoDone:false };

    const plan = load(PKEY);
    const idx = plan.findIndex(x=>x.id === id);
    if(idx < 0) return;

    const it = plan[idx];
    if(it.Uebertragen){ toast("Schon √ºbertragen."); return; }

    const gutName = it.GutNr ? `Gutachten Nr. ${it.GutNr}` : (it.Taetigkeit || "Eintrag");
    const entry = {
      id: uid(),
      planId: it.id,
      Datum: it.Datum || todayISO(),
      Gutachten: gutName,
      Kosten: Number(it.Honorar) || 0,
      Kategorie: it.Taetigkeit || "",
      Klient: it.Notiz || "",
      Bezahlt: ""
    };

    // Kosten pr√ºfen
    const k = clampMoney(entry.Kosten);
    if(k === null){ alert("Honorar muss 0‚Äì1000 ‚Ç¨ sein."); return; }
    entry.Kosten = k;

    const guts = load(GKEY);
    guts.push(entry);
    save(GKEY, guts);

    plan[idx].Uebertragen = true;
    plan[idx].gutId = entry.id;
    if(autoDone) plan[idx].Erledigt = true;
    save(PKEY, plan);

    renderPlan();
    renderGutachten();
    toast("Als Gutachten gespeichert.");

    if(switchTab) showTab("gutachten");
  }

  // ================= Init =================
  fillSelect($("kategorie"), CATEGORY_OPTIONS);
  fillSelect($("planTaetigkeit"), CATEGORY_OPTIONS);

  $("datum").value = todayISO();
  $("planDatum").value = todayISO();

  // Start: Arbeitsplan zuerst
  showTab("plan");

  renderPlan();
  renderGutachten();
</script>
</body>
</html>
