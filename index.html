<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ’— Gutachten Manager Deluxe</title>
  <meta name="theme-color" content="#ff69b4" />

  <style>
    :root{
      --pink:#ff69b4;
      --pink2:#ffb6c1;
      --bg:#ffe6f0;
      --card:#fff;
      --border:rgba(0,0,0,.10);
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:18px;
      --muted:#666;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 600px at 10% 0%, #fff 0%, var(--bg) 45%, #ffd6ea 100%);
    }
    .wrap{max-width:1250px;margin:20px auto;padding:15px;}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:14px;border:1px solid var(--border);}
    h1{margin:0 0 6px;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin:0;line-height:1.35}
    .grid{display:grid;gap:14px;}
    @media(min-width:980px){.grid{grid-template-columns:390px 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin-top:10px;margin-bottom:6px}
    input,select{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--border);
      background:#fff;outline:none;
    }
    input:focus,select:focus{box-shadow:0 0 0 4px rgba(255,105,180,.14);border-color:rgba(255,105,180,.6)}
    button{
      border:0;border-radius:12px;padding:10px 14px;font-weight:650;cursor:pointer;background:var(--pink2);
    }
    button:hover{filter:brightness(.96)}
    .btn-outline{background:#fff;border:1px solid var(--border);font-weight:650}
    .danger{background:#fff;border:1px solid rgba(200,60,60,.35);color:#8b1f1f}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .small{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}

    .tableWrap{overflow:auto;border:1px solid rgba(0,0,0,.08);border-radius:12px;background:rgba(255,255,255,.75)}
    table{width:100%;border-collapse:collapse;min-width:1200px}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(0,0,0,.06);font-size:13px;white-space:nowrap;text-align:left}
    th{background:rgba(250,250,250,.95);position:sticky;top:0;z-index:1;color:var(--muted);font-size:12px}

    .pill{padding:3px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.12);font-size:12px;background:#fff}
    .paid{background:#e7f8ee;border-color:#8ccfa6}
    .unpaid{background:#fdeaea;border-color:#e6a0a0}
    .tag-ok{background:#e7f8ee;border-color:#8ccfa6}
    .tag-warn{background:#fdeaea;border-color:#e6a0a0}

    .bar{height:14px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden;margin-top:8px}
    .bar div{height:100%;background:linear-gradient(90deg,#ff9acb,var(--pink));width:0%}

    nav button.tab-active{background:linear-gradient(90deg,#ff9acb,var(--pink))}
    .toast{
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:#fff;border:1px solid var(--border);padding:10px 14px;border-radius:999px;
      box-shadow:var(--shadow);display:none;z-index:20;
    }
    .toast.show{display:block}
    .icon-btn{padding:8px 10px;border-radius:10px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>ðŸ’— Gutachten Manager Deluxe</h1>
    <p class="sub">Gutachten + Arbeitsplan â€“ alles lokal gespeichert (localStorage)</p>
  </div>

  <nav class="card">
    <div class="btns" style="margin-top:0">
      <button id="tabGutachtenBtn" class="btn-outline">ðŸ’— Gutachten</button>
      <button id="tabPlanBtn" class="btn-outline">ðŸ“… Arbeitsplan</button>
    </div>
  </nav>

  <!-- ================= GUTACHTEN ================= -->
  <div id="sectionGutachten">
    <div class="grid">

      <section class="card">
        <label for="gutachten">Gutachten</label>
        <input id="gutachten" placeholder="z.B. Gutachten Nr. 12" />

        <label for="kosten">Kosten (â‚¬ max 1000)</label>
        <input id="kosten" type="number" step="0.01" min="0" max="1000" placeholder="z.B. 450" />

        <label for="kategorie">Kategorie</label>
        <select id="kategorie"></select>

        <label for="klient">Klient</label>
        <input id="klient" placeholder="optional" />

        <label for="datum">Datum</label>
        <input id="datum" type="date" />

        <label for="bezahlt">Bezahlt</label>
        <select id="bezahlt">
          <option value=""></option>
          <option value="Ja">Ja</option>
          <option value="Nein">Nein</option>
        </select>

        <div class="btns">
          <button id="saveBtn">ðŸ’¾ Speichern</button>
          <button id="chartBtn" class="btn-outline">ðŸ“Š Diagramm</button>
        </div>

        <div class="small" id="progressLabel">â€”</div>
        <div class="bar"><div id="barFill"></div></div>
      </section>

      <section class="card">
        <div class="btns" style="margin-top:0">
          <button id="exportBtn" class="btn-outline">â¬‡ CSV Export</button>
          <label class="btn-outline" style="padding:10px 14px;border-radius:12px;cursor:pointer;">
            â¬† CSV Import
            <input type="file" id="importFile" hidden accept=".csv,text/csv">
          </label>
          <button id="clearBtn" class="danger">ðŸ—‘ Alles lÃ¶schen</button>
        </div>

        <div class="tableWrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Datum</th><th>Gutachten</th><th>Kosten (â‚¬)</th><th>Kategorie</th><th>Klient</th><th>Bezahlt</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <canvas id="chart" height="120" style="display:none;margin-top:14px"></canvas>
      </section>

    </div>
  </div>

  <!-- ================= ARBEITSPLAN ================= -->
  <div id="sectionPlan" style="display:none">
    <div class="grid">

      <section class="card">
        <h3 style="margin:0 0 6px;">ðŸ“… Arbeitsplan</h3>
        <p class="sub">
          TÃ¤tigkeit wird beim Ãœbertragen automatisch als <b>Kategorie</b> im Gutachten gespeichert.
          Zusatzfelder sind immer sichtbar. Kumuliert wird automatisch berechnet.
          <br>âœ… â€žErledigtâ€œ anhaken = automatisch speichern & zum Gutachten-Tab wechseln.
        </p>

        <label for="planDatum">Datum</label>
        <input id="planDatum" type="date" />

        <div class="row2">
          <div>
            <label for="planVon">Von</label>
            <input id="planVon" type="time" />
          </div>
          <div>
            <label for="planBis">Bis</label>
            <input id="planBis" type="time" />
          </div>
        </div>

        <label for="planTaetigkeit">TÃ¤tigkeit</label>
        <select id="planTaetigkeit"></select>

        <div class="row2">
          <div>
            <label for="planGutNr">Gutachten-Nr.</label>
            <input id="planGutNr" placeholder="z.B. 12" />
          </div>
          <div>
            <label for="planHonorar">Honorar pro Eintrag (â‚¬)</label>
            <input id="planHonorar" type="number" step="0.01" min="0" max="1000" placeholder="z.B. 450" />
          </div>
        </div>

        <label for="planKumuliert">Kumuliertes Honorar (â‚¬) (automatisch)</label>
        <input id="planKumuliert" type="text" disabled placeholder="wird berechnet..." />

        <label for="planNotiz">Notiz</label>
        <input id="planNotiz" placeholder="z.B. Klient/Ort/Infos..." />

        <div class="btns">
          <button id="planSaveBtn">ðŸ’¾ Plan speichern</button>
          <button id="planClearBtn" class="danger">ðŸ—‘ Plan komplett lÃ¶schen</button>
        </div>
      </section>

      <section class="card">
        <div class="btns" style="margin-top:0;justify-content:space-between;align-items:flex-start">
          <div class="small" id="planStats">â€”</div>
        </div>

        <div class="tableWrap" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Datum</th>
                <th>Zeit</th>
                <th>TÃ¤tigkeit</th>
                <th>Gutachten-Nr.</th>
                <th>Honorar (â‚¬)</th>
                <th>Kumuliert (â‚¬)</th>
                <th>Notiz</th>
                <th>Erledigt âœ…</th>
                <th>Ãœbertragen ðŸ’¾</th>
                <th>LÃ¶schen</th>
              </tr>
            </thead>
            <tbody id="planTbody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
  // ================= Konfig =================
  const ZIELBETRAG = 45000;
  const GKEY = "gutachten_v3";
  const PKEY = "arbeitsplan_v3";

  // âœ… EINHEITLICHE DROPDOWN-OPTIONEN (TÃ¤tigkeit + Kategorie)
  const CATEGORY_OPTIONS = ["Gutachten", "Ordination", "BBRZ", "Pause"];

  const $ = (id) => document.getElementById(id);

  // ================= Helpers =================
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.classList.remove("show"), 2200);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function load(key){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function save(key, arr){
    localStorage.setItem(key, JSON.stringify(arr));
  }

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function fmtEuro(n){
    const v = Number(n) || 0;
    return v.toLocaleString("de-AT", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function timeRange(von,bis){
    const a = (von||"").trim();
    const b = (bis||"").trim();
    if(!a && !b) return "";
    if(a && b) return `${a}â€“${b}`;
    return a || b;
  }

  function fillSelect(selectEl, options){
    selectEl.innerHTML = `<option value=""></option>` + options.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
  }

  // ================= Tabs =================
  const tabGutachtenBtn = $("tabGutachtenBtn");
  const tabPlanBtn = $("tabPlanBtn");
  const sectionGutachten = $("sectionGutachten");
  const sectionPlan = $("sectionPlan");

  function showTab(name){
    const isGut = name === "gutachten";
    sectionGutachten.style.display = isGut ? "block" : "none";
    sectionPlan.style.display = isGut ? "none" : "block";
    tabGutachtenBtn.classList.toggle("tab-active", isGut);
    tabPlanBtn.classList.toggle("tab-active", !isGut);
  }
  tabGutachtenBtn.addEventListener("click", ()=>showTab("gutachten"));
  tabPlanBtn.addEventListener("click", ()=>showTab("plan"));

  // ================= Gutachten =================
  let chartInstance = null;

  function sumEinnahmen(entries){
    return entries.reduce((acc,e)=> acc + (Number(e.Kosten) || 0), 0);
  }

  function renderProgress(entries){
    const einnahmen = sumEinnahmen(entries);
    const prozent = Math.min(Math.floor((einnahmen / ZIELBETRAG) * 100), 100);
    $("progressLabel").textContent =
      `Einnahmen: ${fmtEuro(einnahmen)} â‚¬ / 45.000 â‚¬ | Gutachten: ${entries.length} | ${prozent}% erreicht`;
    $("barFill").style.width = `${Math.max(0, Math.min(100, prozent))}%`;
  }

  function renderGutTable(entries){
    const tb = $("tbody");
    tb.innerHTML = "";
    const sorted = [...entries].sort((a,b)=> (b.Datum||"").localeCompare(a.Datum||""));
    for(const e of sorted){
      const paid = (e.Bezahlt||"") === "Ja";
      tb.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${escapeHtml(e.Datum||"")}</td>
          <td>${escapeHtml(e.Gutachten||"")}</td>
          <td>${escapeHtml(fmtEuro(e.Kosten))}</td>
          <td>${escapeHtml(e.Kategorie||"")}</td>
          <td>${escapeHtml(e.Klient||"")}</td>
          <td><span class="pill ${paid ? "paid" : "unpaid"}">${escapeHtml(e.Bezahlt||"")}</span></td>
        </tr>
      `);
    }
  }

  function renderGutachten(){
    const entries = load(GKEY);
    renderGutTable(entries);
    renderProgress(entries);
  }

  function addGutachten(entry){
    const k = Number(entry.Kosten);
    if(!Number.isFinite(k)){ alert("Kosten mÃ¼ssen eine Zahl sein."); return false; }
    if(k > 1000){ alert("Einzelwert darf maximal 1.000 â‚¬ betragen."); return false; }
    if(k < 0){ alert("Kosten dÃ¼rfen nicht negativ sein."); return false; }

    const entries = load(GKEY);
    entries.push(entry);
    save(GKEY, entries);
    renderGutachten();
    return true;
  }

  $("saveBtn").addEventListener("click", ()=>{
    const entry = {
      Datum: $("datum").value || todayISO(),
      Gutachten: $("gutachten").value.trim(),
      Kosten: Number($("kosten").value),
      Kategorie: $("kategorie").value.trim(),
      Klient: $("klient").value.trim(),
      Bezahlt: $("bezahlt").value.trim()
    };
    if(addGutachten(entry)){
      $("gutachten").value = "";
      $("kosten").value = "";
      $("kategorie").value = "";
      $("klient").value = "";
      $("datum").value = "";
      $("bezahlt").value = "";
      toast("Gutachten gespeichert.");
    }
  });

  function monthlyAggregate(entries){
    const map = new Map();
    for(const e of entries){
      const key = (e.Datum || "").slice(0,7);
      if(!/^\d{4}-\d{2}$/.test(key)) continue;
      map.set(key, (map.get(key)||0) + (Number(e.Kosten)||0));
    }
    const labels = [...map.keys()].sort();
    return { labels, sums: labels.map(k => Math.round(map.get(k))) };
  }

  $("chartBtn").addEventListener("click", ()=>{
    const entries = load(GKEY);
    const { labels, sums } = monthlyAggregate(entries);
    const canvas = $("chart");
    canvas.style.display = "block";
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(canvas, {
      type:"bar",
      data:{ labels, datasets:[{ label:"Einnahmen (â‚¬)", data:sums }] },
      options:{
        responsive:true,
        plugins:{ title:{ display:true, text:"Monatliche Einnahmen Ãœbersicht" } },
        scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
      }
    });
    if(labels.length === 0) toast("Noch keine Daten fÃ¼rs Monatsdiagramm.");
  });

  // CSV Export/Import (Gutachten)
  function csvEscape(val){
    const s = String(val ?? "");
    if(/[",\n\r;]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }
  $("exportBtn").addEventListener("click", ()=>{
    const entries = load(GKEY);
    const header = ["Datum","Gutachten","Kosten","Kategorie","Klient","Bezahlt"];
    const lines = [header.join(",")];
    for(const e of entries){
      lines.push([
        e.Datum ?? "", e.Gutachten ?? "", e.Kosten ?? "", e.Kategorie ?? "", e.Klient ?? "", e.Bezahlt ?? ""
      ].map(csvEscape).join(","));
    }
    const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "gutachten_erweitert.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast("CSV exportiert.");
  });

  function parseCSV(text){
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    while(i < text.length){
      const c = text[i];
      if(inQuotes){
        if(c === '"'){
          const next = text[i+1];
          if(next === '"'){ field+='"'; i+=2; continue; }
          inQuotes = false; i++; continue;
        }
        field += c; i++; continue;
      }else{
        if(c === '"'){ inQuotes=true; i++; continue; }
        if(c === ","){ row.push(field); field=""; i++; continue; }
        if(c === "\n" || c === "\r"){
          if(c === "\r" && text[i+1] === "\n") i++;
          row.push(field); field="";
          if(row.length > 1 || row[0] !== "") rows.push(row);
          row=[]; i++; continue;
        }
        field += c; i++; continue;
      }
    }
    row.push(field);
    if(row.length > 1 || row[0] !== "") rows.push(row);
    return rows;
  }

  $("importFile").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if(!file){ e.target.value=""; return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const text = String(reader.result || "");
        const rows = parseCSV(text);
        if(rows.length === 0) throw new Error("CSV ist leer.");
        const header = rows[0].map(x=>x.trim().toLowerCase());
        const idx = (name)=> header.findIndex(h=>h===name.toLowerCase());
        const iDatum=idx("datum"), iGut=idx("gutachten"), iKos=idx("kosten"), iKat=idx("kategorie"), iKli=idx("klient"), iBez=idx("bezahlt");
        if([iDatum,iGut,iKos,iKat,iKli,iBez].some(x=>x<0)) throw new Error("CSV Header muss enthalten: Datum,Gutachten,Kosten,Kategorie,Klient,Bezahlt");
        const entries=[];
        for(let r=1;r<rows.length;r++){
          const cols=rows[r];
          const Kosten = Number(String(cols[iKos]||"").replace(",","."));
          if(!Number.isFinite(Kosten) || Kosten<0 || Kosten>1000) continue;
          entries.push({
            Datum:(cols[iDatum]||"").trim() || todayISO(),
            Gutachten:(cols[iGut]||"").trim(),
            Kosten,
            Kategorie:(cols[iKat]||"").trim(),
            Klient:(cols[iKli]||"").trim(),
            Bezahlt:(cols[iBez]||"").trim()
          });
        }
        save(GKEY, entries);
        renderGutachten();
        toast(`CSV importiert (${entries.length} EintrÃ¤ge).`);
      }catch(err){
        alert("Import fehlgeschlagen: " + (err?.message || err));
      }
    };
    reader.readAsText(file);
    e.target.value="";
  });

  $("clearBtn").addEventListener("click", ()=>{
    if(confirm("Wirklich ALLE Gutachten lÃ¶schen?")){
      localStorage.removeItem(GKEY);
      if(chartInstance){ chartInstance.destroy(); chartInstance=null; }
      $("chart").style.display="none";
      renderGutachten();
      toast("Alles gelÃ¶scht.");
    }
  });

  // ================= Arbeitsplan =================
  function planSorted(items){
    return [...items].sort((a,b)=>{
      const d = (a.Datum||"").localeCompare(b.Datum||"");
      if(d!==0) return d;
      return (a.Von||"").localeCompare(b.Von||"");
    });
  }

  function computeKumuliert(sorted){
    let sum = 0;
    const out = [];
    for(const it of sorted){
      sum += Number(it.Honorar) || 0; // âœ… kumuliert jetzt Ã¼ber ALLE TÃ¤tigkeiten (wie Standard)
      out.push({ ...it, Kumuliert: sum });
    }
    return out;
  }

  function refreshPlanKumuliertPreview(){
    const items = planSorted(load(PKEY));
    const withCum = computeKumuliert(items);
    const currentCum = withCum.length ? (withCum[withCum.length-1].Kumuliert || 0) : 0;
    const add = Number($("planHonorar").value) || 0;
    $("planKumuliert").value = fmtEuro(currentCum + add);
  }

  $("planHonorar").addEventListener("input", refreshPlanKumuliertPreview);

  function renderPlan(){
    const items = planSorted(load(PKEY));
    const withCum = computeKumuliert(items);

    const total = withCum.length;
    const done = withCum.filter(x=>x.Erledigt).length;
    const transferred = withCum.filter(x=>x.Uebertragen).length;
    $("planStats").textContent = `EintrÃ¤ge: ${total} | Erledigt: ${done} | Ãœbertragen: ${transferred}`;

    const tb = $("planTbody");
    tb.innerHTML = "";

    for(const it of withCum){
      const hasTransfer = !!it.Uebertragen;
      const transferTag = hasTransfer
        ? `<span class="pill tag-ok">âœ“ gespeichert</span>`
        : `<span class="pill tag-warn">nicht gespeichert</span>`;

      tb.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${escapeHtml(it.Datum||"")}</td>
          <td>${escapeHtml(timeRange(it.Von,it.Bis))}</td>
          <td>${escapeHtml(it.Taetigkeit||"")}</td>
          <td>${escapeHtml(it.GutNr||"")}</td>
          <td>${escapeHtml(fmtEuro(it.Honorar))}</td>
          <td>${escapeHtml(fmtEuro(it.Kumuliert))}</td>
          <td>${escapeHtml(it.Notiz||"")}</td>
          <td><input type="checkbox" data-done="${escapeHtml(it.id)}" ${it.Erledigt ? "checked" : ""} /></td>
          <td>
            <button class="btn-outline icon-btn" data-xfer="${escapeHtml(it.id)}" ${hasTransfer ? "disabled" : ""} title="Als Gutachten speichern">ðŸ’¾</button>
            <span style="margin-left:8px">${transferTag}</span>
          </td>
          <td><button class="danger icon-btn" data-del="${escapeHtml(it.id)}" title="LÃ¶schen">ðŸ—‘</button></td>
        </tr>
      `);
    }

    tb.querySelectorAll('input[type="checkbox"][data-done]').forEach(cb=>{
      cb.addEventListener("change", (e)=>{
        const id = e.target.getAttribute("data-done");
        planSetDone(id, e.target.checked);
      });
    });

    tb.querySelectorAll('button[data-xfer]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-xfer");
        transferPlanToGutachten(id, { switchTab:true, autoDone:true });
      });
    });

    tb.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        planDelete(id);
      });
    });

    refreshPlanKumuliertPreview();
  }

  function planSave(){
    const Taetigkeit = ($("planTaetigkeit").value || "").trim();
    if(!Taetigkeit){ alert("Bitte TÃ¤tigkeit auswÃ¤hlen."); return; }

    const Honorar = Number($("planHonorar").value || 0);
    if(!Number.isFinite(Honorar)){ alert("Honorar muss eine Zahl sein."); return; }
    if(Honorar < 0 || Honorar > 1000){ alert("Honorar muss zwischen 0 und 1000 â‚¬ liegen."); return; }

    const item = {
      id: uid(),
      Datum: $("planDatum").value || todayISO(),
      Von: $("planVon").value || "",
      Bis: $("planBis").value || "",
      Taetigkeit,
      GutNr: $("planGutNr").value.trim(),
      Honorar,
      Notiz: $("planNotiz").value.trim(),
      Erledigt: false,
      Uebertragen: false
    };

    const items = load(PKEY);
    items.push(item);
    save(PKEY, items);

    $("planVon").value = "";
    $("planBis").value = "";
    $("planTaetigkeit").value = "";
    $("planGutNr").value = "";
    $("planHonorar").value = "";
    $("planNotiz").value = "";
    $("planDatum").value = todayISO();

    toast("Arbeitsplan gespeichert.");
    renderPlan();
  }

  function planSetDone(id, done){
    const items = load(PKEY);
    const idx = items.findIndex(x=>x.id === id);
    if(idx < 0) return;

    items[idx].Erledigt = !!done;
    save(PKEY, items);
    renderPlan();

    // âœ… wenn erledigt: automatisch Ã¼bertragen (falls nicht schon)
    if(done && !items[idx].Uebertragen){
      transferPlanToGutachten(id, { switchTab:true, autoDone:false });
    }
  }

  function planDelete(id){
    const items = load(PKEY).filter(x=>x.id !== id);
    save(PKEY, items);
    toast("Plan-Eintrag gelÃ¶scht.");
    renderPlan();
  }

  $("planSaveBtn").addEventListener("click", planSave);
  $("planClearBtn").addEventListener("click", ()=>{
    if(confirm("Wirklich den kompletten Arbeitsplan lÃ¶schen?")){
      localStorage.removeItem(PKEY);
      toast("Arbeitsplan gelÃ¶scht.");
      renderPlan();
    }
  });

  function transferPlanToGutachten(id, opts){
    const { switchTab, autoDone } = opts || { switchTab:true, autoDone:false };

    const plan = load(PKEY);
    const idx = plan.findIndex(x=>x.id === id);
    if(idx < 0) return;

    const it = plan[idx];
    if(it.Uebertragen){ toast("Schon Ã¼bertragen."); return; }

    const gutName = it.GutNr ? `Gutachten Nr. ${it.GutNr}` : (it.Taetigkeit || "Eintrag");
    const entry = {
      Datum: it.Datum || todayISO(),
      Gutachten: gutName,
      Kosten: Number(it.Honorar) || 0,
      Kategorie: it.Taetigkeit || "",     // âœ… TÃ¤tigkeit = Kategorie
      Klient: it.Notiz || "",
      Bezahlt: ""
    };

    if(!addGutachten(entry)) return;

    plan[idx].Uebertragen = true;
    if(autoDone) plan[idx].Erledigt = true;
    save(PKEY, plan);

    renderPlan();
    toast("Als Gutachten gespeichert.");

    if(switchTab){
      showTab("gutachten");
    }
  }

  // ================= Init =================
  // Dropdowns fÃ¼llen (einheitlich)
  fillSelect($("kategorie"), CATEGORY_OPTIONS);
  fillSelect($("planTaetigkeit"), CATEGORY_OPTIONS);

  $("datum").value = todayISO();
  $("planDatum").value = todayISO();
  showTab("gutachten");
  renderGutachten();
  renderPlan();
  refreshPlanKumuliertPreview();
</script>
</body>
</html>
